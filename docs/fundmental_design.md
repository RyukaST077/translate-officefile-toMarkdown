# 1. 概要

## 1.1 目的

指定フォルダ配下の **Word（.docx）** および **Excel（.xls / .xlsx）** を再帰的に探索し、同一フォルダ構造を保ったまま **Markdown（.md）** に一括変換するWindows向けGUIアプリを提供する。

## 1.2 スコープ（初期リリース）

* 変換機能のみ（詳細設定UIなし）
* 対象拡張子：`.docx`, `.xls`, `.xlsx`
* 変換エンジン：Pythonライブラリ **MarkItDown**
* 出力：入力フォルダ名末尾に `_md` を付与したフォルダ（既存なら連番）

## 1.3 前提/制約

* OS：Windows 10/11（64bit）
* Python未インストールでも利用できるよう、アプリ側にPythonランタイムを同梱して配布する
* 社内利用のみ／外部通信しない（テレメトリなし）
* 配布：GitHub Releases からインストーラーを配布（clone不要）

# 2. 全体構成

## 2.1 アーキテクチャ

GUI（フロント）と変換処理（バックエンド）を分離し、GUIフリーズを避けるため変換処理はワーカースレッドで実行する。

* **UI層**：フォルダ選択、実行、進捗表示、完了サマリ表示
* **アプリ層**：入力検証、出力先決定、実行制御、進捗イベント発行
* **変換層**：ファイル探索、MarkItDown呼び出し、Excel画像検出（可能な範囲）、md書き込み
* **基盤層**：ログ、例外処理、パス/ファイル操作

## 2.2 主要コンポーネント

1. `MainWindow`（GUI）
2. `ConversionController`（実行制御・状態管理）
3. `FileScanner`（再帰探索・対象抽出）
4. `OutputPlanner`（出力フォルダ/ファイル名の決定、衝突回避）
5. `DocumentConverter`（MarkItDown呼び出し、後処理）
6. `ExcelImageDetector`（xlsxの画像有無検出：可能な場合のみ）
7. `Logger`（ログ出力：ファイル＋GUI）

# 3. 画面設計（最小構成）

## 3.1 画面項目

* 入力フォルダ選択ボタン（フォルダダイアログ）
* 入力フォルダパス表示
* 出力フォルダパス（自動生成、読み取り専用表示）
* 実行ボタン
* 進捗バー（全体進捗）
* ステータステキスト（例：`12/120 変換中: ...`）
* 完了ダイアログ（成功/失敗件数、出力先、ログファイルへの案内）
* （任意）「出力フォルダを開く」ボタン

## 3.2 画面状態

* 初期：入力未選択→実行不可
* 入力選択済：実行可
* 実行中：入力再選択不可、実行不可（キャンセルは初期は非搭載。将来拡張）
* 完了：実行可（別フォルダに再実行可能）

# 4. 機能設計

## 4.1 入力フォルダ選択

* ユーザーがルートフォルダを選択
* 入力パスの存在・アクセス権（読取）を検証

## 4.2 出力フォルダ決定

* ルール：入力フォルダと同階層に `入力フォルダ名 + "_md"` を作成
* 既存の場合：上書きしないで連番

  * 例：`docs_md` が存在→ `docs_md_2`、さらに存在→ `docs_md_3`…

### 4.2.1 連番付与アルゴリズム（フォルダ）

* `base = input_path + "_md"`
* `base` が未存在なら採用
* 存在する場合 `base_2`, `base_3`…とインクリメントして未存在を採用

## 4.3 対象ファイル探索

* 入力ルート配下を再帰探索
* 対象拡張子：`.docx`, `.xls`, `.xlsx`（大文字小文字は区別しない）
* 除外（固定）：

  * Office一時ファイル：`~$*`
  * 出力フォルダ（`*_md*`）が入力配下に存在している場合は探索対象外（無限ループ回避）

## 4.4 変換処理

### 4.4.1 変換単位

* Word：1ファイル→1md
* Excel：1ブック（1ファイル）→1md（MarkItDown出力をそのまま採用）

### 4.4.2 MarkItDown呼び出し

* `MarkItDown(enable_plugins=False)` を原則とし、プラグインは使用しない
* `result = md.convert(input_file_path)`
* `result.text_content` をmd本文として採用

### 4.4.3 画像の扱い

* 画像はMarkdownへ埋め込まない（MarkItDownの出力に画像が含まれる場合は後処理で除去する）
* Excelのみ：画像の有無を検出できる場合、mdファイル先頭に注記を追加

  * 例：

    * `> 画像ありシート: Sheet1, Sheet3`
* **検出できない場合：注記なし＋ログのみ**

#### 4.4.3.1 画像検出（xlsxのみ、可能な範囲）

* `.xlsx` は `openpyxl` で読み取り、各シートの `images` 等から画像有無を判定
* `.xls` は画像検出を行わない（検出不可としてログ）

### 4.4.4 数式の扱い

* 数式は「結果（表示値）」のみを反映

  * MarkItDown（内部のExcel読み取り）に委ねる
  * 結果が取得できない場合（未計算・キャッシュなし等）は空欄になり得るため、ログに警告を残す

### 4.4.5 出力ファイル名決定（衝突回避）

* 相対パスを維持し、拡張子を `.md` に変更
* 同一フォルダ内で同名 `.md` が既に存在する場合：連番

  * 例：`a.md` が存在→ `a_2.md`, `a_3.md`…

## 4.5 進捗表示

* 探索完了後に総件数を確定
* 1ファイル処理ごとに以下を更新

  * 進捗（n/total）
  * 現在処理中ファイル名

## 4.6 ログ出力

* 出力ルートに `conversion.log` を作成
* ログレベル：INFO/ERROR（必要ならWARNING）
* 記録項目（例）：

  * 実行日時、アプリバージョン
  * 入力/出力パス
  * 変換対象件数、成功/失敗件数
  * 失敗ファイルの相対パス、例外概要
  * 画像検出不可（.xls or 読取失敗）、数式結果取得不可の警告

# 5. 処理フロー（シーケンス）

## 5.1 正常系

1. ユーザーが入力フォルダ選択
2. `OutputPlanner` が出力フォルダパスを決定
3. `FileScanner` が対象ファイル一覧を作成
4. GUIが「総件数」を表示し、ワーカースレッド開始
5. 各ファイルについて：

   * `OutputPlanner` が出力ファイルパスを決定
   * `DocumentConverter` がMarkItDownで変換
   * （xlsxのみ）`ExcelImageDetector` が画像有無を取得し、必要なら先頭注記を付与
   * mdを書き込み
   * 進捗更新
6. 完了サマリ表示（成功/失敗）

## 5.2 例外系（代表）

* 入力フォルダアクセス不可→GUIでエラー表示し中断
* ファイルが開かれていて読めない／パス長等→当該ファイルは失敗としてログ、処理継続
* 出力書き込み不可→当該ファイルは失敗としてログ、処理継続

# 6. 例外設計 / エラーメッセージ方針

* ユーザー向け：短い日本語メッセージ＋「詳細はログ参照」
* ログ：例外スタックトレース（必要最小限）＋対象ファイルパス

代表メッセージ例：

* 「入力フォルダにアクセスできません。権限とパスを確認してください。」
* 「一部ファイルの変換に失敗しました。conversion.log を確認してください。」

# 7. 非機能設計

## 7.1 性能

* 初期リリースは逐次処理（UIは別スレッド）
* 大量ファイルでもUIが固まらないことを優先

## 7.2 セキュリティ

* 外部通信しない
* 変換対象ファイル内容を外部送信しない
* ログに本文を出さない（パス・件数・例外概要のみ）

## 7.3 互換性

* Windowsパス長の影響を受ける可能性があるため、長すぎるパスは失敗としてログ

# 8. ビルド / 配布設計

## 8.1 実装技術（提案）

* 言語：Python 3.10+（MarkItDownの前提に合わせる）
* GUI：Tkinter（標準ライブラリ、配布が容易）
* パッケージング：PyInstaller（one-dir推奨：依存DLLやデータを含めやすい）
* インストーラー：Inno Setup（exe）または WiX（MSI）

  * 初期はInno Setup推奨（実装コスト低）

## 8.2 依存関係

* `markitdown[docx,xlsx,xls]`（必要なオプションのみ）
* `openpyxl`（xlsx画像検出用）

## 8.3 CI/CD（GitHub Actions）

* mainへのタグPushでWindowsビルド
* PyInstallerで成果物生成
* インストーラー作成
* GitHub Releasesへ添付

## 8.4 アップデート

* 自動更新なし（手動）
* 新版インストーラーを実行し上書きインストール（または旧版アンインストール→新規）

## 8.5 署名

* 署名不要（ただしSmartScreen/AVで警告が出る可能性は運用でカバー）

# 9. テスト観点（抜粋）

## 9.1 機能

* フォルダ構造保持（深い階層）
* `_md` 出力フォルダ作成／既存時の連番
* 同名衝突（docxとxlsxが同名、または複数回実行）
* `.xls` / `.xlsx` / `.docx` の変換
* Office一時ファイル除外（`~$`）

## 9.2 品質

* 画像：埋め込まれないこと
* xlsx画像検出：検出できた場合のみ先頭注記、検出できない場合は注記なし＋ログ
* 数式：結果値が出る（出ない場合は警告ログ）

## 9.3 エラー

* 読み取り不可（ロック中）
* 書き込み不可（権限）
* パス長

# 10. 今後の拡張候補（Out of Scope）

* 変換キャンセル
* 対象拡張子追加（pptx/pdf等）
* 詳細設定UI（除外ルール、並列度、ログレベル）
* 変換結果のプレビュー／差分表示
